<html lang="en">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap"
        rel="stylesheet">

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mom Food</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            background: #322C2B;
            display: flex;
            justify-content: center;
            justify-items: center;
            overflow: hidden;
            font-family: "Rubik";
        }


        #container {
            width: 100%; 
            height: 90%;
            background: #AF8260;
            color: white;
            display: flex;
            flex-direction: column;
            overflow-y: hidden;
            margin-top: 5vh;
            padding: 20px;
        }

        #categories_container {
            display: flex;
            flex-wrap: wrap; 
            gap: 20px; 
            overflow-y: scroll;
        }

        #meal_container {
            height: 20vh; /* اختصار لنصف ارتفاع الشاشة، يمكنك ضبطها حسب احتياجاتك */
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            overflow-y: scroll; /* إضافة ميزة التمرير الرأسي إذا تجاوز عدد الوجبات المعروضة الارتفاع المحدد */
        }

        #categories_container>div {
            width: calc(33.33% - 20px);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center; 
            text-align: center; 
        }

        #meal_container > div {
            width: calc(50% - 20px);
            height: 100px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center; 
            text-align: center; 
        }

        #categories_container p {
            font-size: 1.5em; 
            text-align: center;
            margin-top: 10px;
        }

        #meal_container p {
            font-size: 1.5em; 
            text-align: center;
            margin-top: 10px;
        }

        #categories_container>div>img {
            width: 80%; 
            margin: 0 auto;
            image-rendering: pixelated;
        }

        #meal_container > div > img {
            width: 30%;
            margin: 0 auto;
            image-rendering: pixelated;
        }
       
        #categories_container>div>button {
        background: #071739;
        padding: 10px;
        color: white;
        width: 50%;
        border: none;
        border-radius: 5px;
        margin: 0 auto;
    }

    #meal_container>div>button {
        background: red;
        padding: 10px;
        color: white;
        width: 50%;
        margin: 0 auto;
        border: none;
        border-radius: 5px;
    }

    #categories_container>div>div {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 10px; 
        margin-top: 10px;
    }

    #categories_container>div>div>button:first-child {
        margin-right: 10px; 
        margin-bottom: 10px;
    }

        #category_modal {
              display: none;
            flex-direction: column;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; /* تعديل هذه القيمة لتكون مناسبة لشاشة اللابتوب */
            max-width: 600px; /* تعديل هذه القيمة لتكون مناسبة لشاشة اللابتوب */
            height: auto;
            max-height: 80%; /* تعديل هذه القيمة لتكون مناسبة لشاشة اللابتوب */
            background: #803D3B;
            border: 2px dashed black;
            border-radius: 10px;
            padding: 20px;
        }
        #meal_modal {
            display: none;
            flex-direction: column;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; 
            max-width: 600px; 
            height: auto;
            max-height: 80%; 
            background: #803D3B;
            border: 2px dashed black;
            border-radius: 10px;
            padding: 20px;
        }

        #category_modal #close {
            background: red;
            color: white;
            aspect-ratio: 1;
            padding: 4px;
        }

        #meal_modal #close {
            background: red;
            color: white;
            aspect-ratio: 1;
            padding: 4px;
        }
        #category_modal>input {
            width: 100%;
            border: 0;
            border-radius: 10px;
            padding: 10px;
        }

        #save {
            background: #00FF00;
            color: black;
            padding: 10px;
            border-radius: 10px;
           
        }
        #save_meal {
            background: #00FF00;
            color: black; 
            padding: 10px;
            border-radius: 10px;
        }
    </style>
    <script>
        window.state = "create";
        window.updated_id = null;
        window.updated_elements = null;

        window.onload = function () {
            const categories_container = document.getElementById("categories_container");
            function insertCategory(name, image, _id) {
                const category_element = document.createElement("div"); // <div></div>

                const category_name_element = document.createElement("p") // <p></p>
                const category_image_element = document.createElement("img") // <img src="" />
                const category_button_element = document.createElement("button");
                category_name_element.innerHTML = name; // <p>Category Name</p>
                category_image_element.src = image; // <img src="http://localhost3000/image.png" />
                //category_button_element.innerHTML = "View Meals";
                category_element.appendChild(category_name_element); // <div><p>Category Name</p></div>
                category_element.appendChild(category_image_element); // <div><p>Category Name</p><img src="http://localhost3000/image.png" /></div>
                category_element.appendChild(category_button_element);

                category_button_element.onclick = () => {
                    fetchMealsByCategory(id);
                };
                categories_container.appendChild(category_element);

                const category_delete_button = document.createElement("button");
                category_delete_button.innerHTML = "حذف ";
                category_delete_button.onclick = () => {
                    console.log("Deleting category with id: ", _id);
                    fetch(`/api/categories/${_id}`, {
                        method: "DELETE",
                    }).then(response => {
                        if (response.ok) {
                            categories_container.removeChild(category_element)
                        } else {
                            alert("حدث خطأ أثناء حذف هذا الصنف، حاول لاحقًا.")
                        }
                    })
                }

                category_element.appendChild(category_delete_button);

                const category_update_button = document.createElement("button");
                category_update_button.innerHTML = "تحديث";
                category_update_button.onclick = () => {
                    window.state = "update";
                    window.updated_id = _id;
                    window.updated_elements = {
                        name: category_name_element,
                        image: category_image_element,
                    }

                    category_name_input.value = name;
                    category_image_input.value = image;

                    category_modal.style.display = "flex";

                }

                category_element.appendChild(category_update_button);
                categories_container.appendChild(category_element);
            }
            
            // function myAmazingFunction(data) {}
            // const myAmazingFunction = (data, arg1, arg2, arg3) => arg1+arg2
            fetch("http://localhost:3000/api/categories")
                .then(response => response.json()) // JSON => JavaScript Object Notation
                .then(data => {
                    // [] -> Array
                    // {_id: string, name: string, image: string}
                    for (let i = 0; i < data.length; i++) {
                        insertCategory(data[i].name, data[i].image, data[i]._id);
                    }
                })

            const create_category_button = document.getElementById("create_category_button");
            const category_modal = document.getElementById("category_modal");
            create_category_button.onclick = () => {
                category_modal.style.display = "flex"
            }
            const create_meal_button = document.getElementById("create_meal_button");
            const meal_modal = document.getElementById("meal_modal");
            create_meal_button.onclick = () => {
                meal_modal.style.display = "flex"
            }

            const close_meal_button = document.getElementById("close_meal_modal")
            close_meal_button.onclick = () => {
                meal_modal.style.display = "none"
            }
            const close_button = document.getElementById("close")
            close_button.onclick = () => {
                category_modal.style.display = "none"
            }
            const save_button = document.getElementById("save")
            const category_name_input = document.getElementById("category_name");
            const category_image_input = document.getElementById("category_image");
            save_button.onclick = () => {
                const category_data = {
                    name: category_name_input.value,
                    image: category_image_input.value,
                };

                switch (window.state) {
                    case "create": {
                        fetch("/api/categories", {
                            method: "POST",
                            body: JSON.stringify(category_data),
                            headers: {
                                "Content-Type": "application/json"
                            }
                        }).then(response => {
                            if (response.ok) {
                                response.json().then(data => {
                                    insertCategory(category_data.name, category_data.image, data._id);
                                    close_button.click();
                                })
                            } else {
                                alert("حدث خطأ أثناء محاولة إضافة صنف، يرجى المحاولة لاحقًا.");
                            }
                        })
                        break
                    }
                    case "update": {
                        const _id = window.updated_id;

                        console.log("Updating category with id: ", _id);
                        fetch(`/api/categories/${_id}`, {
                            method: "PUT",
                            body: JSON.stringify({
                                _id: _id,
                                name: category_name_input.value,
                                image: category_image_input.value,
                            }),
                            headers: {
                                "Content-Type": "application/json"
                            }
                        }).then(response => {
                            if (response.ok) {
                                response.json().then(data => {
                                    window.updated_elements.name.innerHTML = data.name;
                                    window.updated_elements.image.src = data.image;
                                })
                            } else {
                                alert("حدث خطأ أثناء محاولة تحديث الصنف، يرجى المحاولة مرة أخرى.");
                            }
                        })
                        break
                    }
                }
            }
        
            function insertMeal(name, image, description, price, category, id) {
                const meal_element = document.createElement("div");
                const meal_name_element = document.createElement("p");
                const meal_image_element = document.createElement("img");
                const meal_description_element = document.createElement("p");
                const meal_price_element = document.createElement("p");
                const meal_category_element = document.createElement("p");
                const meal_button_element = document.createElement("button");
                const meal_delete_button = document.createElement("button"); 
            
                meal_name_element.innerHTML = name;
                meal_image_element.src = image;
                meal_description_element.innerHTML = description;
                meal_price_element.innerHTML = price;
                meal_category_element.innerHTML = category; 
                meal_button_element.innerHTML = "View Meal";
                meal_delete_button.innerHTML = "Delete Meal"; 
            
                meal_element.appendChild(meal_name_element);
                meal_element.appendChild(meal_image_element);
                meal_element.appendChild(meal_description_element);
                meal_element.appendChild(meal_price_element);
                meal_element.appendChild(meal_category_element);
                meal_element.appendChild(meal_button_element);
                meal_element.appendChild(meal_delete_button); 
            
                meal_button_element.onclick = () => {
                    fetchMealsByCategory(category); 
                };
                meal_delete_button.onclick = () => {
                    deleteMeal(id); 
                };
            
                const meal_container = document.getElementById("meal_container");
                meal_container.appendChild(meal_element);
            }

                function fetchMealsByCategory(category_id) {
                    fetch(`/api/meals?category=${category_id}`)
                        .then(response => response.json())
                        .then(data => {
                            meal_container.innerHTML = "";
                            for (let i = 0; i < data.length; i++) {
                                insertMeal(data[i].name, data[i].image, data[i].description, data[i].price, data[i]._id);
                            }
                        })
                        .catch(error => {
                            console.error("Error fetching meals: ", error);
                        });
                }
            
                function deleteMeal(meal_id) {
                    fetch(`/api/meals/${meal_id}`, {
                        method: "DELETE",
                    }).then(response => {
                        if (response.ok) {
                            meal_container.removeChild(document.getElementById(meal_id));
                        } else {
                            alert("An error occurred while deleting the meal. Please try again later.");
                        }
                    }).catch(error => {
                        console.error("Error deleting meal: ", error);
                    });
                }
                const meal_delete_button = document.createElement("button");
                meal_delete_button.innerHTML = "Delete Meal";
                meal_delete_button.onclick = () => {
                    deleteMeal(meal_id);
                };
                const meal_element = document.createElement("div");
                meal_element.appendChild(meal_delete_button);
                const meal_category_select = document.getElementById("meal_category");
               meal_category_select.onclick = () => {
                 fetch("http://localhost:3000/api/categories")
                 .then(response => response.json())
                 .then(data => {
                    meal_category_select.innerHTML = "";
                    data.forEach(category => { 
                        const option = document.createElement("option");
                        option.value = category._id;
                        option.innerText = category.name;
                        meal_category_select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Error fetching categories: ", error);
                });
            };
            meal_category_select.onchange = () => {
                console.log("Selected category ID:", meal_category_select.value);
            };
            function updateCategorySelect() {
                const meal_category_select = document.getElementById("meal_category");
                meal_category_select.innerHTML = "<option value='' disabled selected>Select a category</option>";
                categoriesData.forEach(category => {
                    const option = document.createElement("option");
                    option.value = category._id;
                    option.innerText = category.name;
                    meal_category_select.appendChild(option);
                });
            }
                const save_meal_button = document.getElementById("save_meal");
                const meal_name_input = document.getElementById("meal_name");
                const meal_image_input = document.getElementById("meal_image");
                const meal_descreption_input = document.getElementById("meal_description");
                const meal_price_input = document.getElementById("meal_price");
                const meal_category_input = document.getElementById("meal_category");
                save_meal_button.onclick = () => {
                    const meal_data = {
                        name: meal_name_input.value,
                        image: meal_image_input.value,
                        descreption: meal_descreption_input.value,
                        price: meal_price_input.value,
                        category: meal_category_select.value
                    };
                    console.log("Sending the following body: ", JSON.stringify(meal_data));
                    fetch("/api/categories", {
                         method: "POST",
                         body: JSON.stringify(meal_data),
                         headers: {
                            "Content-Type": "application/json"
                        }
                    }).then(response => {
                        if (response.ok) {
                            insertMeal(meal_data.name, meal_data.image, meal_data.descreption,meal_data.price, meal_data.category)
                        close_meal_button.click();
                    } else {
                        alert("حدث خطأ أثناء محاولة إضافة الوجبة، يرجى المحاولة لاحقًا.");
                    }
                    
                })
                
            }
        }
    
    </script>
</head>

<body dir="ltr">
    <div id="container">
        <h1>Mom Food Application!</h1>
        <button id="create_category_button"><h3> اضافة صنف جديد</h3></button>
        <button id="create_meal_button"><h3>اضافة وجبة جديدة</h3></button>

        <div id="categories_container"></div>
        <div id="meal_container"></div></div>
    <div id="category_modal">
        <div>
            <button id="close">X</button>
        </div>
        <h1 style="text-align: center; color: white;">Create Your Category!</h1>
        <input id="category_name" placeholder="Name" />
        <input id="category_image" placeholder="Image URL" />
        <button id="save">Save</button>
    </div>
    <div id="meal_modal">
        <div>
            <button id="close_meal_modal">X</button>
        </div>
        <h1 style="text-align: center; color: white;">!انشئ وجبتك</h1>
        <input id="meal_name" placeholder="Name" />
        <input id="meal_image" placeholder="Image URL" />
        <input id="meal_description" placeholder="descreption" />
        <input id="meal_price" placeholder="price" />
        <select id="meal_category">
            <option value="" disabled selected>Select a category</option>
        </select>
        <button id="save_meal" >Save Meal and Open Page</button>
    </div>
</body>

</html>